<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Hands-on: Estendendo a Java Validation API : Implementando anotações customizadas." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Hands-on: Estendendo a Java Validation API</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/br11/validation_hands-on">View on GitHub</a>

          <h1 id="project_title">Hands-on: Estendendo a Java Validation API</h1>
          <h2 id="project_tagline">Implementando anotações customizadas.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/br11/validation_hands-on/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/br11/validation_hands-on/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>Neste hand-on você intruduzirá em um projeto em andamento uma solução de validação, criando annotations de validação customizadas para dados do tipo java.util.Date, java.lang.Number, e também criando uma annotation para campos de preenchimento obrigatório.</p>

<p>Testes unitários:</p>

<p>Na implementação de componentes reutilizáveis é indispensável o desevolvimento de testes unitários. Para tal foi elaborado um problema que é um cadastro de cidadãos para ingresso nos programas social do governo. Ser um tema simples e cotidiano contribui para o rápido entedimento do código. Através dos testes verificaremos se as implementações atendem os requisitos do negócio e se estão corretas.</p>

<p><img src="https://lh4.googleusercontent.com/oTtONhLtzx3XVaSGIh1dnag_si67dj2hOu401a2GIwWAwE6fHyNIhsyZ7E0trb7XKAdn_rYrIpg0lQ5UzF4szp78666LCAwl1xpEPsTqna_DzuhHZU4TowLZktyCMfJK2Q" alt=""></p>

<p>Siga atentamente as instruções contidas nas três seções a seguir antes de iniciar a execução dos exercícios.</p>

<p>Este documento também está disponível em <a href="https://docs.google.com/document/d/17pHqcyzgc-ITM1H3BIg10HSj13EJ4gePFREPTQutGko/pub">https://docs.google.com/...</a></p>

<h3>
<a name="requisitos" class="anchor" href="#requisitos"><span class="octicon octicon-link"></span></a>Requisitos</h3>

<ul>
<li>Git</li>
<li>JDK 1.7.x</li>
<li>Maven 3.x</li>
<li>Eclipse Standard IDE</li>
</ul><h3>
<a name="prepara%C3%A7%C3%A3o" class="anchor" href="#prepara%C3%A7%C3%A3o"><span class="octicon octicon-link"></span></a>Preparação</h3>

<p>Executar os seguintes passos para baixar os fontes e gerar o projeto do Eclipse.</p>

<pre><code>&gt; mkdir hands-on
&gt; cd hands-on
&gt; git clone https://github.com/br11/validation_hands-on.git
&gt; cd validation_hands-on
&gt; mvn eclipse:clean eclipse:eclipse
</code></pre>

<p>Após executar os comandos acima, importe o projeto no eclipse.
Caso não queira usar Maven e Git você podera fazer o download e descompactar o arquivo .zip, criar um projeto no eclipse apontando para a pasta descompactada. No Eclipse, crie uma source folder apontando para <em>src/main/java</em>.</p>

<p>Execute a aplicação.</p>

<h3>
<a name="execu%C3%A7%C3%A3o" class="anchor" href="#execu%C3%A7%C3%A3o"><span class="octicon octicon-link"></span></a>Execução</h3>

<p>Execute os casos de testes que são apresentados para verificar o resultado das implementações que forem feitas.</p>

<h3>
<a name="exerc%C3%ADcios" class="anchor" href="#exerc%C3%ADcios"><span class="octicon octicon-link"></span></a>Exercícios</h3>

<p>É necessários que os exercício seja executados em sequência. Durante a codificação, aproveite para explorar o código fonte e analisar as alterações que estão sendo propostas. Sempre execute a aplicação após concluir cada exercício - siga as instruções descritas na sessão Execução.</p>

<p><strong>Exercício 1</strong>: Implementar uma annotation para validar campos cujo preenchimento é obrigatório.</p>

<p><strong>Exercício 1.1</strong>: Implemente uma annotação, aproveitando a configuração de internacionalização de mensagens de erro.</p>

<p>Required.java</p>

<pre><code>@Target({ ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE,
        ElementType.CONSTRUCTOR, ElementType.PARAMETER })
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = RequiredValidator.class)
public @interface Required {

    @Target({ ElementType.METHOD, ElementType.FIELD,
            ElementType.ANNOTATION_TYPE, ElementType.CONSTRUCTOR,
            ElementType.PARAMETER })
    @Retention(RetentionPolicy.RUNTIME)
    public static @interface List {

        Class&lt;?&gt;[] groups() default {};

        Class&lt;? extends Payload&gt;[] payload() default {};

        Required[] value();
    }

    String message() default "{javax.validation.constraints.NotNull.message}";

    Class&lt;?&gt;[] groups() default {};

    Class&lt;? extends Payload&gt;[] payload() default {};
}
</code></pre>

<p><br><strong>Exercício 1.2</strong>: Implementar o validador da annotation que modo que qualquer campo possa ser anotado e que a mensagem de erro possa estar sempre adequada ao tipo de dado.</p>

<p>RequiredValidator.java</p>

<pre><code>private boolean validateBySize(int size, ConstraintValidatorContext context) {
    if (size == 0) {
        buildConstraintViolation(context,
                 "{javax.validation.constraints.Size.message}");
        return false;
    }
    return true;
}
</code></pre>

<p><br><strong>Exercício 1.3</strong>: Aplicar o componente de tratamento de exceção à tela.</p>

<p>Emprego.java  </p>

<pre><code>public class Emprego {
    private long id;

    private String cargo;

    @Required
    private String empresa;

    @Required
    private Date admissao;

    @Required(groups = Programas.SeguroDesemprego.class)
    private Date demissao;
</code></pre>

<p><br><strong>Exercício 1.4</strong>: Crie um test case para validar o preenchimento dos campos que você acabou de anotar.</p>

<p>TesteEmprego.java  </p>

<pre><code>@Test
public void testRequired() {
    Emprego bean = new Emprego();
    new TestUtil().checkViolations(bean, "empresa", "admissao");

    bean.setEmpresa("    ");
    new TestUtil().checkViolations(bean, "empresa", "admissao");
}
</code></pre>

<p><br><strong>Exercício 1.5</strong>: Crie outro test case para validar os campos obrigatórios para o programa de Seguro Desemprego..</p>

<p>TesteEmprego.java  </p>

<pre><code>@Test
public void testSeguroDesemprego() {
    Emprego bean = new Emprego();
    new TestUtil(Programas.SeguroDesemprego.class)
            .checkViolations(bean, "demissao");
}
</code></pre>

<p><br><strong>Exercício 2</strong>: Implementar uma annotation para validar campos numéricos. Validar valor máximo e mínimo, e número de casas decimais.</p>

<p><strong>Exercício 2.1</strong>: Mais uma vez, implemente uma annotação, aproveitando a configuração de internacionalização de mensagens de erro.</p>

<p>ExceptionHandler.java</p>

<pre><code>@Target({ ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE,
        ElementType.CONSTRUCTOR, ElementType.PARAMETER })
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = NumericValidator.class)
public @interface Numeric {

    @Target({ ElementType.METHOD, ElementType.FIELD,
            ElementType.ANNOTATION_TYPE, ElementType.CONSTRUCTOR,
            ElementType.PARAMETER })
    @Retention(RetentionPolicy.RUNTIME)
    public static @interface List {

        Class&lt;?&gt;[] groups() default {};

        Class&lt;? extends Payload&gt;[] payload() default {};

        Numeric[] value();
    }

    public static final String CURRENCY = "#########.##";

    String message() default "{javax.validation.constraints.Digits.message}";

    Class&lt;?&gt;[] groups() default {};

    Class&lt;? extends Payload&gt;[] payload() default {};

    String value();

    double min() default Double.MIN_VALUE;

    double max() default Double.MAX_VALUE;
}
</code></pre>

<p><br><strong>Exercício 2.2</strong>: Implementar o validador da annotation que modo que qualquer campo possa ser anotado e que a mensagem de erro possa estar sempre adequada ao tipo da violação ocorrida.</p>

<p>NumericValidator.java</p>

<pre><code>    public boolean isValid(Object value, ConstraintValidatorContext context) {
            if (!requiredValidator.isValid(value, context)) {
                    return true;
            }

            BigDecimal big = util.toBig(value);
            if (big.compareTo(min) &lt; 0 &amp;&amp; big.compareTo(max) &gt; 0) {
                    buildConstraintViolation(context,
                             "{br.atech.workshop.validation.Range.message}");
                    return false;

            } else if (big.compareTo(min) &lt; 0) {
                    buildConstraintViolation(context,
                             "{javax.validation.constraints.Min.message}");
                    return false;

            } else if (big.compareTo(max) &gt; 0) {
                    buildConstraintViolation(context,
                             "{javax.validation.constraints.Max.message}");
                    return false;

            } else if (!util.isValid(value, integerSize, fractionSize)) {
                    return false;
            }
            return true;
    }
</code></pre>

<p><br><strong>Exercício 2.3</strong>: Aplicaque uma validação ao campo último salário de modo que este não possa ser igual a zero e a parte inteira não ultrapasse 9 digitos.</p>

<p>Emprego.java</p>

<pre><code>    @Numeric(value = "#########.##", min = 0.01)
    private BigDecimal ultimoSalario;
</code></pre>

<p><br><strong>Exercício 2.4</strong>: Crie um test case para validar o valor do campo que você acabou de anotar.</p>

<p>TesteEmprego.java  </p>

<pre><code>@Test
public void testUltimoSalario() {
    Emprego bean = new Emprego();
    bean.setEmpresa("XPTO");
    bean.setAdmissao(new Date());

    /* salário ok */
    bean.setUltimoSalario(new BigDecimal("10000.250"));
    new TestUtil().checkViolations(bean);

    /* excesso de casas decimais */
    bean.setUltimoSalario(new BigDecimal("10000.001"));
    new TestUtil().checkViolations(bean, "ultimoSalario");

    /* excede o valor máximo permitido para o campo */
    bean.setUltimoSalario(new BigDecimal("1000000000.00"));
    new TestUtil().checkViolations(bean, "ultimoSalario");
}
</code></pre>

<p><br><strong>Exercício 3</strong>: Agora chegou o grande momento que todos esperavam: implementar uma validação de datas.</p>

<p><strong>Exercício 3.1</strong>: Implemente uma annotation para validar datas que já possua um conjunto de restrições pré-definidas para que o usuário escolha. Deixe a mensagem de erro vazia para indicar que esta dever ser dinamicamente gerada a partir da restrição que foi violada.</p>

<p>DateRange.java</p>

<pre><code>    String message() default "";

    Class&lt;?&gt;[] groups() default {};

    Class&lt;? extends Payload&gt;[] payload() default {};

    Ranges min() default Ranges.Past;
    Ranges max() default Ranges.Future;

    int minGap() default 0;
    int maxGap() default 0;

    Ranges[] value() default Ranges.Any;
}
</code></pre>

<p><br><strong>Exercício 3.2</strong>: No validador da annotation, implemente a geração dinâmica da mensagem de erro.</p>

<p>DateRangeValidator.java</p>

<pre><code>private void buildConstraintViolation(ConstraintValidatorContext context,
        Ranges... ranges) {
    context.disableDefaultConstraintViolation();
    for (Ranges range : ranges) {
        context.buildConstraintViolationWithTemplate(
                range.getErrorMessage()).addConstraintViolation();
    }
}
</code></pre>

<p><br><strong>Exercício 3.3</strong>: Aplicaque uma validação ao campo data de nascimento do menor de idade. A regra é que o cadastro é válido até o final do mês em que o menor completa 18 anos.</p>

<p>MenorDeIdade.java</p>

<pre><code>public class MenorDeIdade {
    @Required
    private String nome;

    @DateRange(min = DateRange.Ranges.ThisMonth, minGap = -18 * 12,
                 groups = Programas.BolsaFamilia.class)

    @Required(groups = Programas.BolsaFamilia.class)
    private Date dataDeNascimento;
</code></pre>

<p><br><strong>Exercício 3.4</strong>: Crie um test case para validar o valor do campo que você acabou de anotar.</p>

<p>TesteMenorDeIdade.java  </p>

<pre><code>@Test
public void testBolsaFamiliaMenorIdade() {
    MenorDeIdade bean = new MenorDeIdade();
    bean.setNome("fulano de tal");

    /* idades em meses */
    int recemNascido = 0;
    int dezoito = (18 * 12);
    int idadeAdultaQualquer = (21 * 12); // 21 anos

    /* de recem nascido à 17 anos de idade é válido */
    for (int idade = recemNascido; idade &lt; dezoito; idade++) {
        bean.setDataDeNascimento(util.calculaDataDeNascimento((char) idade));
        new TestUtil(Programas.BolsaFamilia.class).checkViolations(bean);
    }

    /*
     * No dia em que completa dezoito anos é válido.
     */
    Date dezoitoExatos = util.calculaDataDeNascimento((char) dezoito);
    bean.setDataDeNascimento(dezoitoExatos);
    new TestUtil(Programas.BolsaFamilia.class).checkViolations(bean);

    /*
     * dezoito anos e uns dias - requisito diz ser valido até o final mês em
     * que completa a maioridade.
     */
    Date inicioDoMes = util.set(dezoitoExatos, Calendar.DAY_OF_MONTH, 1);
    bean.setDataDeNascimento(inicioDoMes);
    new TestUtil(Programas.BolsaFamilia.class).checkViolations(bean);

    /* prestes a completar 18 anos é válido */
    Date fimDoMes = util.set(dezoitoExatos, Calendar.DAY_OF_MONTH, 28);
    bean.setDataDeNascimento(fimDoMes);
    new TestUtil(Programas.BolsaFamilia.class).checkViolations(bean);

    /* 18 anos 1 um mês ou mais não é válido */
    for (int idade = idadeAdultaQualquer; idade &gt; dezoito; idade--) {
        bean.setDataDeNascimento(util.calculaDataDeNascimento((char) idade));
        new TestUtil(Programas.BolsaFamilia.class).checkViolations(bean,
                "dataDeNascimento");
    }
}
</code></pre>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Hands-on: Estendendo a Java Validation API maintained by <a href="https://github.com/br11">br11</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
